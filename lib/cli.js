var action,authorize,cheerio,commander,delayedResolve,fetch,fetchForCookie,fetchForPage,fs,getVersion,path,request;fs=require("fs"),path=require("path"),cheerio=require("cheerio"),commander=require("commander-b"),request=require("./request"),getVersion=function(){var e,r,t;return t=path.join(__dirname,"../package.json"),e=fs.readFileSync(t,{encoding:"utf-8"}),r=JSON.parse(e),r.version},authorize=function(e){return request({jar:e,method:"POST",url:"https://my.jcb.co.jp/iss-pc/member/user_manage/Login",form:{userId:process.env.MYMYJCB_USERNAME,password:process.env.MYMYJCB_PASSWORD,screenId:"0102001",loginRouteId:"0102001"}})},fetchForCookie=function(e){return request({jar:e,url:"https://my.jcb.co.jp/iss-pc/member/details_inquiry/detail.html",qs:{detailMonth:1,output:"web"}})},fetchForPage=function(e,r){if(0>r||r>6)throw new Error("invalid pageNo: "+r);return request({jar:jar,url:"https://my.jcb.co.jp/iss-pc/member/details_inquiry/detail.html",qs:{detailMonth:r,output:"web"}}).then(function(e){var r,t;return r=cheerio.load(e.body),t=null,r("select option[selected=selected]").each(function(){var e;return e=r(this),t={label:e.text(),amount:r(".amount strong").text()}}),t})},delayedResolve=function(e,r){return new Promise(function(t){return setTimeout(function(){return t(e)},r)})},fetch=function(){var e;return e=request.jar(),Promise.resolve().then(function(){return console.log("authorize"),authorize(e)}).then(function(){return console.log("fetch cookie"),fetchForCookie(e)}).then(function(){return console.log("fetch [0..6]"),[0,1,2,3,4,5,6].reduce(function(r,t){return r.then(function(r){return console.log("fetch ["+t+"]"),fetchForPage(e,t).then(function(e){var t,n,o;return o=null!=e?e:{},n=o.label,t=o.amount,null!=n?r[n]=t:void 0}).then(function(){return deleyedResolve(r,500)})})},Promise.resolve({}))}).then(function(e){return console.log(e)})["catch"](function(e){return console.error(e)})},action=function(){return fetch()},module.exports=function(){var e;return e=commander(),e.version(getVersion()),e.action(action),e.execute()};