var authorize,cheerio,commander,delayedResolve,fetch,fetchForCookie,fetchForPage,fs,getVersion,loadCredentials,moment,parsePage,path,request,table;fs=require("fs"),path=require("path"),cheerio=require("cheerio"),commander=require("commander-b"),moment=require("moment"),request=require("./request"),table=require("table-b"),getVersion=function(){var e,r,n;return n=path.join(__dirname,"../package.json"),e=fs.readFileSync(n,{encoding:"utf-8"}),r=JSON.parse(e),r.version},loadCredentials=function(e){var r,n,t,o;return o=e.username,t=e.password,r=path.join(process.env.HOME,".mymyjcb.json"),n={},fs.existsSync(r)&&(n=JSON.parse(fs.readFileSync(r,{encoding:"utf-8"}))),null!=process.env.MYMYJCB_USERNAME&&(n.username=process.env.MYMYJCB_USERNAME),null!=process.env.MYMYJCB_PASSWORD&&(n.password=process.env.MYMYJCB_PASSWORD),null!=o&&(n.username=o),null!=t&&(n.password=t),n},parsePage=function(e){var r,n;return r=cheerio.load(e.body),n=null,r("select option[selected=selected]").each(function(){var e,t,o,s,a,u,i;return o=r(this),s=o.text(),e=r(".amount strong").text(),a=s.match(/^(\d+)年(\d+)月(\d+)日.*?(未?確定).*$/),i=parseInt(a[1],10),u=parseInt(a[2],10)-1,t=parseInt(a[3],10),n={date:moment({year:i,month:u,day:t}).format("YYYY-MM-DD"),fixed:"確定"===a[4],amount:parseInt(e.replace(/[\s,円]/g,""),10)}}),n},authorize=function(e,r,n){return request({jar:e,method:"POST",url:"https://my.jcb.co.jp/iss-pc/member/user_manage/Login",form:{userId:r,password:n,screenId:"0102001",loginRouteId:"0102001"}})},fetchForCookie=function(e){return request({jar:e,url:"https://my.jcb.co.jp/iss-pc/member/details_inquiry/detail.html",qs:{detailMonth:1,output:"web"}})},fetchForPage=function(e,r){if(0>r||r>6)throw new Error("invalid pageNo: "+r);return request({jar:e,url:"https://my.jcb.co.jp/iss-pc/member/details_inquiry/detail.html",qs:{detailMonth:r,output:"web"}}).then(parsePage)},delayedResolve=function(e,r){return new Promise(function(n){return setTimeout(function(){return n(e)},r)})},fetch=function(e){var r;return r=request.jar(),Promise.resolve().then(function(){return loadCredentials(e)}).then(function(e){var n,t;if(t=e.username,n=e.password,null==t)throw new Error("username is not defined");if(null==n)throw new Error("password is not defined");return console.log("authorize"),authorize(r,t,n)}).then(function(){return console.log("fetch cookie"),fetchForCookie(r)}).then(function(){return console.log("fetch [0..6]"),[0,1,2,3,4,5,6].reduce(function(e,n){return e.then(function(e){return console.log("fetch ["+n+"]"),fetchForPage(r,n).then(function(r){var n,t,o,s;return s=null!=r?r:{},t=s.date,o=s.fixed,n=s.amount,null!=t?e[t]={date:t,fixed:o,amount:n}:void 0}).then(function(){return delayedResolve(e,500)})})},Promise.resolve({}))}).then(function(e){var r,n,t,o,s,a,u;return s=["date","amount","fixed"],u=function(){var s,u;u=[];for(r in e)s=e[r],t=s.date,o=s.fixed,n=s.amount,a=n.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,"),u.push([t,a,o]);return u}(),console.log("\n"),console.log(table([s].concat(u),{align:["l","r","l"]}))})["catch"](function(e){return console.error(e)})},module.exports=function(){var e;return e=commander(),e.version(getVersion()),e.option("--username <username>","MyJCB username"),e.option("--password <password>","MyJCB password"),e.action(fetch),e.execute()};