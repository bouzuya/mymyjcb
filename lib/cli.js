var action,authorize,cheerio,commander,delayedResolve,fetch,fetchForCookie,fetchForPage,fs,getVersion,moment,path,request,table;fs=require("fs"),path=require("path"),cheerio=require("cheerio"),commander=require("commander-b"),moment=require("moment"),request=require("./request"),table=require("table-b"),getVersion=function(){var e,t,r;return r=path.join(__dirname,"../package.json"),e=fs.readFileSync(r,{encoding:"utf-8"}),t=JSON.parse(e),t.version},authorize=function(e){return request({jar:e,method:"POST",url:"https://my.jcb.co.jp/iss-pc/member/user_manage/Login",form:{userId:process.env.MYMYJCB_USERNAME,password:process.env.MYMYJCB_PASSWORD,screenId:"0102001",loginRouteId:"0102001"}})},fetchForCookie=function(e){return request({jar:e,url:"https://my.jcb.co.jp/iss-pc/member/details_inquiry/detail.html",qs:{detailMonth:1,output:"web"}})},fetchForPage=function(e,t){if(0>t||t>6)throw new Error("invalid pageNo: "+t);return request({jar:e,url:"https://my.jcb.co.jp/iss-pc/member/details_inquiry/detail.html",qs:{detailMonth:t,output:"web"}}).then(function(e){var t,r;return t=cheerio.load(e.body),r=null,t("select option[selected=selected]").each(function(){var e,n,o,u,i,c,a;return o=t(this),u=o.text(),e=t(".amount strong").text(),i=u.match(/^(\d+)年(\d+)月(\d+)日.*?(未?確定).*$/),a=parseInt(i[1],10),c=parseInt(i[2],10)-1,n=parseInt(i[3],10),r={date:moment({year:a,month:c,day:n}).format("YYYY-MM-DD"),fixed:"確定"===i[4],amount:parseInt(e.replace(/[\s,円]/g,""),10)}}),r})},delayedResolve=function(e,t){return new Promise(function(r){return setTimeout(function(){return r(e)},t)})},fetch=function(){var e;return e=request.jar(),Promise.resolve().then(function(){return console.log("authorize"),authorize(e)}).then(function(){return console.log("fetch cookie"),fetchForCookie(e)}).then(function(){return console.log("fetch [0..6]"),[0,1,2,3,4,5,6].reduce(function(t,r){return t.then(function(t){return console.log("fetch ["+r+"]"),fetchForPage(e,r).then(function(e){var r,n,o,u;return u=null!=e?e:{},n=u.date,o=u.fixed,r=u.amount,null!=n?t[n]={date:n,fixed:o,amount:r}:void 0}).then(function(){return delayedResolve(t,500)})})},Promise.resolve({}))}).then(function(e){var t,r,n,o,u,i,c;return u=["date","amount","fixed"],c=function(){var u,c;c=[];for(t in e)u=e[t],n=u.date,o=u.fixed,r=u.amount,i=r.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,"),c.push([n,i,o]);return c}(),console.log("\n"),console.log(table([u].concat(c),{align:["l","r","l"]}))})["catch"](function(e){return console.error(e)})},action=function(){return fetch()},module.exports=function(){var e;return e=commander(),e.version(getVersion()),e.action(action),e.execute()};